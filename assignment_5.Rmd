---
title: "ESM 206, Assignment 5"
author: "Andrew Salvador & Benson Truong"
date: "11/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

NOTE: We are not capitalizing "old growth" and "clear cut" throughout the document, unless using the abbreviation (OG) & (CC)
```{r}
# Attach necessary packages

library(tidyverse)
library(janitor)
library(effsize)
library(kableExtra)
library(ggpubr)
library(broom)
library(devtools)

```

```{r}
# Read in data

initial_data <- read_csv("mack_creek_vertebrates.csv")

# Clean up data and filter for only Pacific Giant Salamanders (species code "DITE") 
# pgs = pacific giant salamander

pgs_clean <- initial_data %>% 
  filter(SPECIES == "DITE") %>% 
  clean_names() 
  

```


## Results {.tabset .tabset-fade}

### Results A

Salamander count in clear cut (CC) and old growth (OG) sections of Mack Creek from 1993 to 2017. Trends are fairly similar in both sections. 
```{r}

# Filter by section and year
pgs_count <- pgs_clean %>% 
  count(section, year) %>% 
  mutate(year = as.character(year))

# Rename the years using abbreviations 
pgs_count$year <- gsub("1993", "'93", pgs_count$year)
pgs_count$year <- gsub("1994", "'94", pgs_count$year)
pgs_count$year <- gsub("1995", "'95", pgs_count$year)
pgs_count$year <- gsub("1996", "'96", pgs_count$year)
pgs_count$year <- gsub("1997", "'97", pgs_count$year)
pgs_count$year <- gsub("1998", "'98", pgs_count$year)
pgs_count$year <- gsub("1999", "'99", pgs_count$year)
pgs_count$year <- gsub("2000", "'00", pgs_count$year)
pgs_count$year <- gsub("2001", "'01", pgs_count$year)
pgs_count$year <- gsub("2002", "'02", pgs_count$year)
pgs_count$year <- gsub("2003", "'03", pgs_count$year)
pgs_count$year <- gsub("2004", "'04", pgs_count$year)
pgs_count$year <- gsub("2005", "'05", pgs_count$year)
pgs_count$year <- gsub("2006", "'06", pgs_count$year)
pgs_count$year <- gsub("2007", "'07", pgs_count$year)
pgs_count$year <- gsub("2008", "'08", pgs_count$year)
pgs_count$year <- gsub("2009", "'09", pgs_count$year)
pgs_count$year <- gsub("2010", "'10", pgs_count$year)
pgs_count$year <- gsub("2011", "'11", pgs_count$year)
pgs_count$year <- gsub("2012", "'12", pgs_count$year)
pgs_count$year <- gsub("2013", "'13", pgs_count$year)
pgs_count$year <- gsub("2014", "'14", pgs_count$year)
pgs_count$year <- gsub("2015", "'15", pgs_count$year)
pgs_count$year <- gsub("2016", "'16", pgs_count$year)
pgs_count$year <- gsub("2017", "'17", pgs_count$year)
pgs_count$year <- gsub("2018", "'18", pgs_count$year)



# Graph it, setting tick marks every two years so the axis labels don't overlap
ggplot(pgs_count, aes(x = year,
                      y = n)) +
  geom_col(aes(color = section,
               fill = section,
               alpha = .8),
               show.legend = FALSE) +
  scale_x_discrete(limits = c("'93", "'94", "'95", "'96", "'97", "'98", "'99", "'00", "'01", "'02", "'03", "'04", "'05", "'06", "'07", "'08", "'09", "'10", "'11", "'12", "'13", "'14", "'15", "'16", "'17"),
                   breaks = c("'93", "'95", "'97", "'99", "'01", "'03", "'05", "'07", "'09", "'11", "'13", "'15", "'17")) +
  scale_y_continuous(limits = c(0, 400), expand = c(0,0)) +
  facet_wrap(~section) +
  labs(x = "Year",
       y = "Salamander Count")


  


```
***Figure 1.*** *Sample salamander counts from years 1993 to 2017 for clear cut (CC) and old growth (OG) sections of Mack Creek. Clear cut section shown in red while old growth section shown in blue. Data: Aquatic Vertebrate Population Study in Mack Creek, Andrews Experimental Forest, 1987 to present.*

```{r}
# A different way to show compare count on the same graph could be a line graph so that the two counts overlap. Maybe easier to visualize differences?
# Just messing around trying to make a line graph (failing miserably)

ggplot(pgs_count, aes(x = year,
                      y = n)) +
  geom_line(aes(color = section)) +
  scale_x_discrete(limits = c("'93", "'94", "'95", "'96", "'97", "'98", "'99", "'00", "'01", "'02", "'03", "'04", "'05", "'06", "'07", "'08", "'09", "'10", "'11", "'12", "'13", "'14", "'15", "'16", "'17"))
  labs(x = "Year",
       y = "Salamander Count")

 
```

```{r}

# A different visualization for salamander count
ggplot(pgs_count, aes(x = year,
                      y = n)) +
  geom_point(aes(color = section),
             size = 3,
             show.legend = FALSE) +
  scale_x_discrete(limits = c("'93", "'94", "'95", "'96", "'97", "'98", "'99", "'00", "'01", "'02", "'03", "'04", "'05", "'06", "'07", "'08", "'09", "'10", "'11", "'12", "'13", "'14", "'15", "'16", "'17"),
  breaks = c("'93", "'95", "'97", "'99", "'01", "'03", "'05", "'07", "'09", "'11", "'13", "'15", "'17")) +
  scale_y_continuous(limits = c(0, 400), expand = c(0,0)) +
  geom_segment(aes(x = year,
               y = 0,
               xend = year,
               yend = n,
               color = section),
               show.legend = FALSE) +
  facet_wrap(~section) +
  labs(x = "Year",
       y = "Salamander Count")

```



### Results B

***Table 1.*** *Counts and proportions of salamanders observed in different channel classifications (cascades, pool, side-channel) within two different sections (clear cut & old growth) in Mack Creek in 2017. Table excludes salamanders observed in isolated pools (IP) disconnected from the channel. Data: Aquatic Vertebrate Population Study in Mack Creek, Andrews Experimental Forest, 1987 to present.*
```{r}
# Count and proportions of salamanders in different channel classifications (pool (P) cascade (C), side-channel (SC)). Exclude Isolated Pools (IP)

pgs_class <- pgs_clean %>% 
  filter(year == "2017") %>% 
  count(section, unittype) %>% 
  filter(unittype %in% c("C", "P", "SC"))

# Use pivot wider to make a contingency table so the column headers are the channel classifications 

pgs_class_table <- pgs_class %>% 
  pivot_wider(names_from = unittype,
              values_from = n) %>% 
  rename("Cascades" = C, "Pool" = P, "Side-Channel" = SC, "Section" = section)

# Rename CC and OG 
pgs_class_table$Section <- gsub("CC", "Clear Cut", pgs_class_table$Section)
pgs_class_table$Section <- gsub("OG", "Old Growth", pgs_class_table$Section)

# use adorn funciton to show percentage and actual values
pgs_class_prop <- pgs_class_table %>% 
  janitor::adorn_percentages(denominator = "row") %>% 
  adorn_pct_formatting(digits = 2) %>% 
  adorn_ns(position = "front")

#Now convert to a kableExtra table

kable(pgs_class_prop) %>% 
  kable_styling()



```




### Results C

```{r}
# Now do a chi square test to see if section has any affect on channel classification
# We only want to use the counts so we change the section column into the rownames
contingency_table_c <- pgs_class_table %>% 
  column_to_rownames('Section')

# Now run the chi-square test 
channelclass_chi <- chisq.test(contingency_table_c)
channelclass_chi
```

Section (clear cut or old growth) does not have a significant effect on a salamander location within the channel (cascade, side-channel, pool) ($\chi$^2^(`r channelclass_chi$parameter`)) = `r channelclass_chi$statistic`) (Table 1). For salamander observations in the clear cut section n = 368, for observations in the old growth section n = 320. 




















### Results D
```{r}
# Testing the mean weights for PGS in 2017 for OG and CC sections
# For Old Growth
pgs_og <- pgs_clean %>% 
  filter(year == "2017",
         section == "OG") %>% 
  pull(weight)

# For Clear Cut
pgs_cc <- pgs_clean %>% 
  filter(year == "2017",
         section == "CC") %>% 
  pull(weight)


# Just making some vectors that show the mean of clear cut and og weights in 2017
cc_weight_2017 <- pgs_clean %>% 
  filter(year == "2017", section == "CC") 
 
mean_cc_weight_2017 <- mean(cc_weight_2017$weight, na.rm = TRUE)

og_weight_2017 <- pgs_clean %>% 
  filter(year == "2017", section == "OG")

mean_og_weight_2017 <- mean(og_weight_2017$weight, na.rm = TRUE)

og_cc_ttest <- t.test(pgs_og, pgs_cc)
og_cc_ttest

# P-value of 0.09599, retain null hypothesis
# There is no significant difference between in mean weights for Pacific giant salamanders observed in the two forest sections in 2017. 
```
Mean salamander weight in clear cut and old growth sections did not differ significantly in 2017 (t(`r round(og_cc_ttest$parameter, 2)`) = `r round(og_cc_ttest$statistic, 2)`, *p* > 0.05). Mean salamander weight in the clear cut section was 18% greater than in the old growth section, with an actual difference of 1.19 grams. For salamanders observed in the clear cut section mean = 7.78g, n = 368, while for salamanders observed in the old growth section, mean = 6.58g, n = 320. 









### Results E
```{r}
# Compare weights of PGS in pools, cascades and side-channels of Mack Creek in 2017
pgs_summary <- pgs_clean %>% 
  filter(year == "2017",
         unittype %in% c("P", "C", "SC"))

ggplot(data = pgs_summary, aes(x = weight))+
  geom_histogram(aes(fill=unittype))+
  facet_wrap(~unittype)

ggplot(data = pgs_summary, aes(x = unittype, y = weight))+
  geom_violin(aes(color=unittype))+
  facet_wrap(~unittype)
```



